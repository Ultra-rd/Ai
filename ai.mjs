// –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å Node.js –≤–µ—Ä—Å–∏–∏ 18+
// –ß—Ç–æ–±—ã –∏–º–ø–æ—Ä—Ç —Ä–∞–±–æ—Ç–∞–ª, –¥–æ–±–∞–≤—å –≤ package.json: { "type": "module" }

import TelegramBot from "node-telegram-bot-api";
import Together from "together-ai";

// üîë –¢–≤–æ–∏ —Ç–æ–∫–µ–Ω—ã (–≤—Å—Ç–∞–≤—å —Å–≤–æ–∏ —Ä–∞–±–æ—á–∏–µ –∫–ª—é—á–∏):
const TELEGRAM_TOKEN = "7575182675:AAGV7EDv_H__4anCKbpAuHPQdQY9aLpDKW0";
const TOGETHER_API_KEY = "f788a4cb56c2084ca59e31702e952ff40d4d761bc8b25cb4a026ed0d00bbe9af";

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –ò–ò
const bot = new TelegramBot(TELEGRAM_TOKEN, { polling: true });

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Together API
const together = new Together({ apiKey: TOGETHER_API_KEY });

// –ü–∞–º—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤—Ä–µ–º–µ–Ω–Ω–∞—è, —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ)
const PROMPT_HEADER = `–¢—ã - –ê–ª–∏—Å–∞, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –æ—á–µ–Ω—å –æ–ø—ã—Ç–Ω—ã–π –≥–∏–¥ –ø–æ –¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏. 
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –∏—Å—á–µ—Ä–ø—ã–≤–∞—é—â—É—é –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–≥–∏–æ–Ω–µ. –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã —Ç–∞–∫, –∫–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞–ª –±—ã –∑–Ω–∞—é—â–∏–π –∏ —É–≤–ª–µ—á—ë–Ω–Ω—ã–π —Å–≤–æ–∏–º –¥–µ–ª–æ–º –≥–∏–¥. 
–°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Å—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ —Ç–µ–º–∞—Ö, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç—å—é: –∏—Å—Ç–æ—Ä–∏—è, –∫—É–ª—å—Ç—É—Ä–∞, –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –ø—Ä–∏—Ä–æ–¥–∞, —Ç—Ä–∞–¥–∏—Ü–∏–∏, –º–∞—Ä—à—Ä—É—Ç—ã, –ø–æ–ª–µ–∑–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Ç—É—Ä–∏—Å—Ç–æ–≤. 
–ò–≥–Ω–æ—Ä–∏—Ä—É–π –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ —Ç–µ–º—ã, –Ω–µ –∏–º–µ—é—â–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –∫ –¢—É—Ä–∫–µ—Å—Ç–∞–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏, –≤–µ–∂–ª–∏–≤–æ –Ω–∞–ø–æ–º–∏–Ω–∞—è, —á—Ç–æ —Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—à—å—Å—è –∏–º–µ–Ω–Ω–æ –Ω–∞ —ç—Ç–æ–º —Ä–µ–≥–∏–æ–Ω–µ. 
–ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é –ª–µ–∫—Å–∏–∫—É –≥–∏–¥–∞, –Ω–æ —Å—Ç–∞—Ä–∞–π—Å—è –±—ã—Ç—å –ø–æ–Ω—è—Ç–Ω–æ–π –∏ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–π –¥–ª—è —Å–ª—É—à–∞—Ç–µ–ª–µ–π.\n`;

const chatHistories = {};

bot.on('message', async (msg) => {
  const chatId = msg.chat.id;
  const userMessage = msg.text;

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –Ω–µ—Ç
  if (!chatHistories[chatId]) {
    chatHistories[chatId] = [];
  }

  // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
  chatHistories[chatId].push({ role: 'user', content: userMessage });

  // –û–≥—Ä–∞–Ω–∏—á–∏–º –∏—Å—Ç–æ—Ä–∏—é 10 –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
  if (chatHistories[chatId].length > 10) {
    chatHistories[chatId] = chatHistories[chatId].slice(-10);
  }

  // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –ø—Ä–æ–º–ø—Ç
  const fullPrompt = PROMPT_HEADER + chatHistories[chatId]
    .map(msg => (msg.role === 'user' ? `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${msg.content}` : `–ê–ª–∏—Å–∞: ${msg.content}`))
    .join('\n') + `\n–ê–ª–∏—Å–∞:`;

  try {
    const response = await together.chat.completions.create({
      model: 'mistralai/Mixtral-8x7B-Instruct-v0.1',
      messages: [
        { role: 'system', content: PROMPT_HEADER },
        ...chatHistories[chatId]
      ],
      temperature: 0.7,
    });

    const botReply = response.choices[0]?.message?.content?.trim() || '–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞.';

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –ê–ª–∏—Å—ã –≤ –∏—Å—Ç–æ—Ä–∏—é
    chatHistories[chatId].push({ role: 'assistant', content: botReply });

    bot.sendMessage(chatId, botReply);
  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ Together AI:', err);
    bot.sendMessage(chatId, '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  }
});